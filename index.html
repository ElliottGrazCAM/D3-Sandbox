<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live QBO Profit & Loss</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        .axis text { font-size: 14px; font-weight: bold; }
        .label { font-size: 14px; font-weight: bold; fill: white; text-anchor: middle; }
    </style>
</head>
<body>

<div class="card">
    <h2>YTD Profit & Loss Summary</h2>
    <p>Live data fetched from QuickBooks Online.</p>
    <div id="chart-container"></div>
</div>

<script>
    d3.json("data.json").then(data => {
        
        // 1. A helper function to hunt down specific row totals in the messy QBO JSON
        function findValue(rows, targetName) {
            let foundValue = 0;
            function search(rowArray) {
                if (!rowArray) return;
                for (let r of rowArray) {
                    // Check if this row has summary data matching our target
                    if (r.Summary && r.Summary.ColData && r.Summary.ColData[0].value === targetName) {
                        foundValue = parseFloat(r.Summary.ColData[1].value);
                    }
                    // If there are nested rows, search them too
                    if (r.Rows && r.Rows.Row) search(r.Rows.Row);
                }
            }
            search(rows);
            return foundValue;
        }

        // 2. Extract the big three numbers
        const allRows = data.Rows.Row;
        const totalIncome = findValue(allRows, "Total Income");
        const totalExpenses = findValue(allRows, "Total Expenses");
        const netIncome = findValue(allRows, "Net Income");

        const chartData = [
            { category: "Total Income", value: totalIncome, color: "#2ca02c" },   // Green
            { category: "Total Expenses", value: totalExpenses, color: "#d62728" }, // Red
            { category: "Net Income", value: netIncome, color: "#1f77b4" }          // Blue
        ];

        // 3. Set up D3 Chart Dimensions
        const margin = {top: 20, right: 20, bottom: 40, left: 60},
              width = 560 - margin.left - margin.right,
              height = 350 - margin.top - margin.bottom;

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 4. Create Scales
        const x = d3.scaleBand()
            .domain(chartData.map(d => d.category))
            .range([0, width])
            .padding(0.3);

        const y = d3.scaleLinear()
            .domain([0, d3.max(chartData, d => d.value) * 1.1]) // Add 10% headroom
            .nice()
            .range([height, 0]);

        // 5. Add Axes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        svg.append("g")
            .call(d3.axisLeft(y).tickFormat(d => "$" + d.toLocaleString()));

        // 6. Draw the Bars
        svg.selectAll(".bar")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.category))
            .attr("y", d => y(d.value))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.value))
            .attr("fill", d => d.color);

        // 7. Add Labels inside the bars
        svg.selectAll(".label")
            .data(chartData)
            .enter()
            .append("text")
            .attr("class", "label")
            .attr("x", d => x(d.category) + x.bandwidth() / 2)
            .attr("y", d => y(d.value) + 20)
            .text(d => "$" + d.value.toLocaleString());

    }).catch(error => {
        console.error("Error loading the data.json file:", error);
        d3.select("#chart-container").html("<p style='color:red;'>Waiting for GitHub Action to pull the new P&L report...</p>");
    });
</script>

</body>
</html>
